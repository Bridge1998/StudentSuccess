CREATE TABLE UF_R2_PROG_STA AS(
SELECT 
A.PERSON_SID,
A.ACAD_PLAN,
B.EFFDT_SID,
B.END_EFFDT_SID,
A.PROG_STATUS_SID,
MAX(B.EFFDT_SID) AS "MAXEFF",
MIN(B.EFFDT_SID) AS "MINEFF"

FROM UF_R2_PROG_STAV1 A INNER JOIN UF_F_CPPS B
ON A.PERSON_SID = B.PERSON_SID
and A.ACAD_PLAN = B.ACAD_PLAN
WHERE B.ACAD_CAR_SID =8
AND
    (
	B.EFFDT_SID = (SELECT MAX(B_ED.EFFDT_SID) 
	FROM UF_F_CPPS B_ED 
		WHERE B.PERSON_SID = B_ED.PERSON_SID                
                  AND B.ACAD_CAREER = B_ED.ACAD_CAREER
     		  AND B.ACAD_PLAN = B_ED.ACAD_PLAN)
              )
GROUP BY A.PERSON_SID,A.ACAD_PLAN,B.EFFDT_SID,B.END_EFFDT_SID,,A.PROG_STATUS_SID
)


CREATE TABLE UF_R2_PROG_STAV2 AS(
SELECT 
A.PERSON_SID,
A.ACAD_PLAN,
(case when A.PROG_STATUS_SID = 4 then (1)
else (0)
end)AS "SUCCESS_GRADUATES",
A.MAXEFF,
A.MINEFF,
(case when A.PROG_STATUS_SID = 4 AND (A.MAXEFF - A.MINEFF) >=39900 then ('5yrs')
when A.PROG_STATUS_SID = 4 AND (A.MAXEFF - A.MINEFF <39900) then ('4yrs') 
else ('no')
end)AS "STUDENT_SUCCESS"
FROM UF_R2_PROG_STA A 
)


CREATE TABLE UF_R2_ANALYSIS_GRASUS AS(
SELECT
A.PERSON_SID,
A.ACAD_CAR_SID,
A.INSTITUTION_SID,
A.STDNT_CAR_NBR,
A.TERM_SID,
A.STRM,
A.TERM_BEG_DT_SID,
A.TERM_END_DT_SID,
A.INSTITUTION,
A.ACAD_CAREER,
A.AGE_YEARS,
A.AGE_MONTHS,
A.AGE_DAYS,
A.TOT_CUMULATIVE,
A.JUNIOR_SENIOR_FLAG,
A.TOT_TAKEN_PRGRSS,
A.TOT_TRNSFR,
A.TOT_TEST_CREDIT,
A.TOT_OTHER,
A.TOT_PASSD_PRGRSS,
A.UNT_TAKEN_PRGRSS,
A.CUR_GPA,
A.CUM_GPA,
A.ENRL_CNT,
A.ENRL_FLG,
A.SSR_TRMAC_LAST_DT,
A.ACAD_LEVEL_BOT,
A.ACAD_LEVEL_EOT,
A.UF_CLASS,
A.RESIDENCY,
A.LASTUPD_EW_DTTM,
A.ACADEMIC_LOAD,
A.TOT_GRADE_POINTS,
A.TOT_TAKEN_GPA,
A.ENRL_SUMMER_A_FLAG,
A.ENRL_SUMMER_B_FLAG,
A.ENRL_SUMMER_C_FLAG,
A.ACAD_PROG_PRIMARY,
A.UF_CLASS_EOT,
A.UNT_TAKEN_GPA,
A.UNT_INPROG_GPA,
A.TERM_FIRST_APPT_TIME,
A.TERM_END_DT_SID_CATGRY,
A.TERM_BEG_DT_CATGRY,
A.TERM_LENGTH_CATEGORY,
A.TERM_LENGTH_DAYS,
A.TERM_SEASON,
A.LOW_TERM_GPA_IND,
A.PARTTIME_TERM_IND,
A.NOT_REG_TERM_IND,
A.WITHDRWL_TERM_IND,
A.FULLTIME_TERM_IND,
A.OVR_12HR_TERM_IND,
A.STDNT_GROUP_SID,
A.EFFDT_SID,
A.END_EFFDT_SID,
A.EFF_STATUS,
A.EFF_START_TERM,
A.EFF_START_TERM_LD,
A.EFF_END_TERM,
A.EFF_END_TERM_LD,
A.CURRENT_IND,
A.LASTUPDOPRID,
A.COMMENTS,
A.ACAD_SPLAN_SID,
B.ACAD_PLAN,
B.SUCCESS_GRADUATES,
B.STUDENT_SUCCESS
FROM UFDL_PWCBA_DATA.uf_r2_analysis_undergradv2 A INNER JOIN UFDL_PWCBA_DATA.uf_d_acad_plan C
ON C.ACAD_PROG_CD = A.ACAD_PROG_PRIMARY
INNER JOIN UFDL_PWCBA_DATA.uf_r2_prog_stav2 B
ON B.ACAD_PLAN = C.ACAD_PLAN_CD
and A. PERSON_SID = B.PERSON_SID
WHERE C.ACAD_PLAN_TYPE_SD ='Major'
)
